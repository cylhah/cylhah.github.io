!function(){"use strict";class e{constructor(){this.eventDispatcher=new Laya.EventDispatcher}static get Instance(){return this.inst||(this.inst=new e),this.inst}hasListener(e){return this.eventDispatcher.hasListener(e)}event(e,t){return this.eventDispatcher.event(e,t)}on(e,t,a,n){return this.eventDispatcher.on(e,t,a,n)}once(e,t,a,n){return this.eventDispatcher.once(e,t,a,n)}off(e,t,a,n){return this.eventDispatcher.off(e,t,a,n)}offAll(e){return this.eventDispatcher.offAll(e)}offAllCaller(e){return this.eventDispatcher.offAllCaller(e)}isMouseEvent(e){return this.eventDispatcher.isMouseEvent(e)}}var t;!function(e){e.ClickGameBoard="ClickGameBoard",e.BoxItemDrop="BoxItemDrop",e.GameEnd="GameEnd",e.CreateNewReadyBox="CreateNewReadyBox",e.CorrectCurrentBox="CorrectCurrentBox"}(t||(t={}));class a{constructor(e,t){this.x=e,this.y=t}}class n{}n.GameMeshWidth=7,n.GameMeshHeight=8,n.InitialGameMeshHeight=2,n.GameBoxItemSize=new a(84,84),n.GameMeshStartPosition=new a(0,588);class s extends Laya.Script{init(e){this.gameMeshX=e;let t=this.owner,a=s.ClickBoxStartPosition.x+e*n.GameBoxItemSize.x;t.pos(a,0)}onClick(a){e.Instance.event(t.ClickGameBoard,this.gameMeshX)}}s.ClickBoxStartPosition=new a(66,0);class o{static random(e,t){return Math.floor(Math.random()*(t-e)+e)}static fill2DAry(e,t,a){let n=[];for(let s=0;s<e;s++)for(let e=0;e<t;e++)n[s]||(n[s]=[]),n[s][e]=a;return n}}class i{constructor(){}static get Instance(){return this.instance||(this.instance=new i),this.instance}init(){this.GameBoardArray=o.fill2DAry(n.GameMeshHeight,n.GameMeshWidth,null)}placeBoxItem(e,t,a){this.GameBoardArray[t][e]=a}getBoxItemId(e,t){if(t<0||t>=n.GameMeshHeight||e<0||e>=n.GameMeshWidth)return null;let a=this.GameBoardArray[t][e];return a?a.boxId:null}calcDropY(e){for(let t=0;t<this.GameBoardArray.length;t++){if(null==this.GameBoardArray[t][e])return t}return null}}class r extends Laya.Script{constructor(){super(...arguments),this.meshX=-1,this.meshY=-1}init(e){this.boxId=e,this.switchTargetImage(e)}switchTargetImage(e){this.owner.loadImage(`image/box/game_box_${e}.png`)}updateSelfXYData(e,t){this.meshX=e,this.meshY=t}posToGameBoard(e,t){let a=this.transMeshXYToOffset(e,t);this.owner.pos(a.x,a.y),this.updateSelfXYData(e,t)}currectBox(){let e=0;for(let t=this.meshY-1;t>=0;t--){i.Instance.GameBoardArray[t][this.meshX]||e++}if(e>0){let t=this.meshY-e;return i.Instance.GameBoardArray[this.meshY][this.meshX]==this&&i.Instance.placeBoxItem(this.meshX,this.meshY,null),this.posToGameBoard(this.meshX,t),i.Instance.placeBoxItem(this.meshX,this.meshY,this),this}return null}destroyBoxItem(){this.owner.destroy()}transMeshXYToOffset(e,t){return new a(n.GameMeshStartPosition.x+n.GameBoxItemSize.x*e,n.GameMeshStartPosition.y-n.GameBoxItemSize.y*t)}}class h extends Laya.Script{onAwake(){e.Instance.on(t.ClickGameBoard,this,this.onGameBoardClick)}onDestroy(){e.Instance.off(t.ClickGameBoard,this,this.onGameBoardClick),e.Instance.event(t.CreateNewReadyBox)}onGameBoardClick(a){if(this.checkGameEnd(a))return void e.Instance.event(t.GameEnd);let s=this.owner,o=a*n.GameBoxItemSize.x;Laya.Tween.to(s,{x:o,y:-n.GameBoxItemSize.x},300,Laya.Ease.linearNone,Laya.Handler.create(this,this.onTweenCompelete,[a]))}checkGameEnd(e){return null==i.Instance.calcDropY(e)}onTweenCompelete(e){let t=this.owner,a=i.Instance.calcDropY(e),n=this.transMeshXYToOffset(e,a);Laya.Tween.to(t,{x:n.x,y:n.y},300,Laya.Ease.linearNone,Laya.Handler.create(this,this.onDropCompelete,[e,a]))}transMeshXYToOffset(e,t){return new a(n.GameMeshStartPosition.x+n.GameBoxItemSize.x*e,n.GameMeshStartPosition.y-n.GameBoxItemSize.y*t)}onDropCompelete(a,n){let s=this.owner.getComponent(r);i.Instance.placeBoxItem(a,n,s),s.updateSelfXYData(a,n),e.Instance.event(t.BoxItemDrop,[a,n]),this.destroy()}posToGameBoardReadyArea(){this.owner.pos(252,-n.GameBoxItemSize.x)}}class c extends Laya.Script{onAwake(){this.gameBoard=this.owner.getChildByName("GameBackground").getChildByName("GameBoard"),this.clickContainer=this.owner.getChildByName("GameBackground").getChildByName("ClickContainer"),this.initEventListener(),i.Instance.init(),this.initGameBoard(),this.initClickBoxes()}onDestroy(){this.removeEventListener()}initEventListener(){e.Instance.on(t.GameEnd,this,this.onGameEnd),e.Instance.on(t.CreateNewReadyBox,this,this.createReadyBox),e.Instance.on(t.BoxItemDrop,this,this.onBoxItemDrop)}removeEventListener(){e.Instance.off(t.GameEnd,this,this.onGameEnd),e.Instance.off(t.CreateNewReadyBox,this,this.createReadyBox),e.Instance.off(t.BoxItemDrop,this,this.onBoxItemDrop)}onGameEnd(){console.log("onGameEnd")}onBoxItemDrop(e,t){this.handleMatch(e,t)}calcMatchedItemAry(e,t){let a=i.Instance.getBoxItemId(e,t),s=n.GameMeshWidth,r=n.GameMeshHeight,h=[],c=o.fill2DAry(r,s,0),l=0,m=0,d={x:e,y:t};h[m++]=d;let y=[],B=[-1,1,0,0],I=[0,0,-1,1];for(c[t][e]=1;m!=l;){d=h[l++],y.push(d);for(let e=0;e<B.length;e++){let t=d.x+B[e],n=d.y+I[e],o=i.Instance.getBoxItemId(t,n);t>=0&&t<s&&n>=0&&n<r&&o==a&&0==c[n][t]&&(c[n][t]=1,h[m++]={x:t,y:n})}}return y}handleMatch(e,t){if(null==i.Instance.getBoxItemId(e,t))return;let a=this.calcMatchedItemAry(e,t);if(a.length>=3){for(let e=0;e<a.length;e++){let t=a[e].x,n=a[e].y;i.Instance.GameBoardArray[n][t].destroyBoxItem(),i.Instance.placeBoxItem(t,n,null)}this.currectCurrentGameBoard()}}currectCurrentGameBoard(){let a=[];for(let e=0;e<i.Instance.GameBoardArray.length;e++)for(let t=0;t<i.Instance.GameBoardArray[e].length;t++){let n=i.Instance.GameBoardArray[e][t];if(n){let e=n.currectBox();e&&a.push(e)}}for(let n=0;n<a.length;n++){let s=a[n];e.Instance.event(t.BoxItemDrop,[s.meshX,s.meshY])}}createReadyBox(){let e=this.GameBoxItem.create();e.getComponent(r).init(this.getRandomItemId()),e.addComponent(h).posToGameBoardReadyArea(),this.gameBoard.addChild(e)}getRandomItemId(){return o.random(1,10)}initGameBoard(){let e=n.InitialGameMeshHeight*n.GameMeshWidth;for(let t=0;t<e;t++){let e=t%n.GameMeshWidth,a=Math.floor(t/n.GameMeshWidth),s=this.GameBoxItem.create(),o=s.getComponent(r),h=this.getRandomItemId();o.init(h),o.posToGameBoard(e,a),this.gameBoard.addChild(s),i.Instance.GameBoardArray[a][e]=o}this.createReadyBox()}initClickBoxes(){for(let e=0;e<n.GameMeshWidth;e++){let t=this.ClickBox.create();t.getComponent(s).init(e),this.clickContainer.addChild(t)}}}class l{constructor(){}static init(){var e=Laya.ClassUtils.regClass;e("script/MainGame.ts",c),e("script/BoxItem.ts",r),e("script/ClickBox.ts",s)}}l.width=720,l.height=1280,l.scaleMode="fixedauto",l.screenMode="none",l.alignV="top",l.alignH="center",l.startScene="Main/Main.scene",l.sceneRoot="",l.debug=!1,l.stat=!1,l.physicsDebug=!1,l.exportSceneToJson=!0,l.init();new class{constructor(){window.Laya3D?Laya3D.init(l.width,l.height):Laya.init(l.width,l.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=l.scaleMode,Laya.stage.screenMode=l.screenMode,Laya.stage.alignV=l.alignV,Laya.stage.alignH=l.alignH,Laya.URL.exportSceneToJson=l.exportSceneToJson,(l.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),l.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),l.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){l.startScene&&Laya.Scene.open(l.startScene)}}}();